name: Release
permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0
      - name: Run Tests
        run: zig build test

  build-library:
    name: Build Library (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-windows
          - x86-windows
          - x86_64-linux
          - x86-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos
          - x86_64-freestanding
          - aarch64-freestanding
          - riscv64-freestanding
          - arm-freestanding
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      
      - name: Build Library
        run: zig build -Doptimize=ReleaseSafe -Dtarget=${{ matrix.target }}

      - name: Rename Artifact (Windows)
        if: contains(matrix.target, 'windows')
        run: mv zig-out/lib/mcp.lib mcp-${{ matrix.target }}.lib

      - name: Rename Artifact (Unix)
        if: contains(matrix.target, 'windows') == false
        run: mv zig-out/lib/libmcp.a libmcp-${{ matrix.target }}.a

      - name: Upload Artifact
        run: gh release upload ${{ github.event.release.tag_name }} ${{ contains(matrix.target, 'windows') && format('mcp-{0}.lib', matrix.target) || format('libmcp-{0}.a', matrix.target) }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  update-release:
    name: Update Release Description
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Get Release URL
        id: get_url
        run: echo "url=https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz" >> $GITHUB_OUTPUT

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0

      - name: Calculate Hash
        id: calc_hash
        run: |
          zig fetch --save ${{ steps.get_url.outputs.url }}
          # Extract hash from build.zig.zon (it's updated by zig fetch)
          HASH=$(grep '.hash =' build.zig.zon | cut -d '"' -f 2)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Update Release Body
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_TOKEN }}
          body: |
            ${{ github.event.release.body }}

            ### Option A ‚Äî Automatic (Recommended)

            Run this to install the dependency and automatically save the hash:

            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            After running, Zig updates your `build.zig.zon` with something like:

            ```zig
            .dependencies = .{
                .mcp = .{
                    .url = "https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz",
                    .hash = "${{ steps.calc_hash.outputs.hash }}",
                },
            },
            ```

            ### Option B ‚Äî Manual

            ```bash
            zig fetch --hash https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            Copy that hash into:

            ```zig
            .hash = "<your_hash_here>"
            ```

            ## üì• Downloads (Prebuilt Library)

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Windows | x86_64 | [mcp-x86_64-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/mcp-x86_64-windows.lib) |
            | Windows | x86 | [mcp-x86-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/mcp-x86-windows.lib) |
            | Linux | x86_64 | [libmcp-x86_64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-x86_64-linux.a) |
            | Linux | x86 | [libmcp-x86-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-x86-linux.a) |
            | Linux | aarch64 (ARM64) | [libmcp-aarch64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-aarch64-linux.a) |
            | macOS | x86_64 (Intel) | [libmcp-x86_64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-x86_64-macos.a) |
            | macOS | aarch64 (Apple Silicon) | [libmcp-aarch64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-aarch64-macos.a) |
            | Bare Metal | x86_64 | [libmcp-x86_64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-x86_64-freestanding.a) |
            | Bare Metal | aarch64 | [libmcp-aarch64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-aarch64-freestanding.a) |
            | Bare Metal | RISC-V 64 | [libmcp-riscv64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-riscv64-freestanding.a) |
            | Bare Metal | ARM | [libmcp-arm-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libmcp-arm-freestanding.a) |

            ### üõ†Ô∏è Using Prebuilt Libraries

            1. Download the library for your platform.
            2. Place it in your project (e.g., in a `libs/` folder).
            3. Update your `build.zig`:

            ```zig
            // Assuming you placed the library in `libs/`
            exe.addLibraryPath(b.path("libs"));
            exe.linkSystemLibrary("mcp");
            ```
